<!DOCTYPE html>
<html>
<head>
<script src='https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/p5.min.js'></script>
</head>


<body>

<script>
	// INITIALIZE VARIABLES
	var hero = new player();
	var enemies = [];
	var score = 0;
	var bestscore = 0;
	var gamestarted = false;
	var img;
	var msgshow = false;
	var msgtimer = 0;
	var blockCount = 10;
	var difficultyTimer = 0;

function preload() {
	img = loadImage('https://gippoo.github.io/dodger/nervous-pepe-monkas-twitch-emote.png');
}

function player() {
	this.x = 290;
    	this.y = 350;
    	this.width = 50;
    	this.height = 50;
    	this.speed = 3;
    
    	this.create = function() {
    		fill(0, 255, 0);
    		image(img,this.x,this.y,this.width,this.height);
        	this.bottom = this.y + this.height-15;
    		this.top = this.y+15;
    		this.left = this.x+15;
    		this.right = this.x + this.width-15;
    	}
    
    	this.mright = function() {
    		if ((this.x + this.speed) <= (610 - this.width)) {
        		this.x += this.speed;
        	}
    	}
    	this.mleft = function() {
    		if ((this.x - this.speed) >= -10) {
        		this.x -= this.speed;
        	}
    	}
    	this.mdown = function() {
    		if ((this.y + this.speed) <= (412 - this.height)) {
        		this.y += this.speed;
        	}
    	}
    	this.mup = function() {
    		if ((this.y - this.speed) >= -10) {
        		this.y -= this.speed;
        	}
    	}
}

function enemy() {
	this.speed = Math.random() * 6 + 3
    	this.x = Math.random() * 590;
    	this.y = -300;
    	this.height = Math.floor(Math.random() * 100) + 20;
	this.width = Math.floor(Math.random() * 20) + 10;
    
    	this.create = function() {
    		if (this.y > 400+this.height) {
        		this.speed = Math.random() * 6 + 3;
        		this.x = Math.random() * 590;
    			this.y = -300;
           	 	this.height = Math.floor(Math.random() * 100) + 20;
			this.width = Math.floor(Math.random() * 20) + 10;
        	}
    		fill(148, 216, 134);
    		rect(this.x,this.y,this.width,this.height);
    	}
    
    	this.drop = function() {
    		this.y += this.speed;
    	}
    
    	this.hit = function() {
    		this.bottom = this.y + this.height;
        	this.top = this.y;
        	this.left = this.x;
        	this.right = this.x + this.width;
        
        	if ((hero.bottom > this.top) && (hero.top < this.bottom) && (hero.left < this.right) && (hero.right > this.left)) {
            		if (score > bestscore) {
            			bestscore = score;
            		}
            		resetState();
    		}
        }
}

function setup() {
	var canv = createCanvas(600, 400);
    	background(187, 209, 247);
	canv.parent('gamearea');
    
    	for (let i = 0; i < 15; i++) {
    		enemies[i] = new enemy();
    	}
}


function animate() {
	if (gamestarted) {
    		hero.create();
		for (let baddy of enemies) {
    			baddy.create();
        		baddy.drop();
        		baddy.hit();
    		}
    
   		// MOVEMENT
    		if (keyIsDown(RIGHT_ARROW)) {
    			hero.mright();
    		}
    		if (keyIsDown(LEFT_ARROW)) {
    			hero.mleft();
    		}
    		if (keyIsDown(DOWN_ARROW)) {
    			hero.mdown();
    		}
    		if (keyIsDown(UP_ARROW)) {
    			hero.mup();
    		}
    
    		score += 1/30;
		difficultyTimer += 1;
    	} else {    
    		textSize(32);
    		fill(0);
		text('Press ENTER to start', 145, 200);
    	}
    	
}

function draw() {
	background(187, 209, 247);
	animate();
    	textSize(16);
    	fill(0);
	text('SCORE: ' + score.toFixed(0), 10, 20);
    	text('BEST: ' + bestscore.toFixed(0), 10, 40);
	difficulty();
}

function keyPressed() {
	if (keyCode === ENTER) {
		gamestarted = true;
	}
}

function difficulty() {
	if (difficultyTimer % 6000 == 0 && gamestarted && difficultyTimer != 0) {
    		msgshow = true;
		for (let i = blockCount; i < blockCount + 5; i++) {
        		enemies[i] = new enemy();
        	}
		blockCount += 5
    	}
    	showmsg();
}

function showmsg () {
	if (msgshow && msgtimer <= 2) {
    		textSize(28);
    		fill(130, 57, 1);
		text('DANGER: MORE BLOCKS', 150, 50);
        	msgtimer += 1/60;
        	if (msgtimer > 2) {
        		msgshow = false;
            		msgtimer = 0;
        	}
    	}
}


function resetState () {
	hero = new player();
        score = 0;
	enemies = [];
        for (let i = 0; i < 10; i++) {
    		enemies[i] = new enemy();
	}
        msgtimer = 0;
        gamestarted = false;
	msgshow = false;
        blockcount = 10;
}


</script>

	<center><h3>Use the arrow keys to dodge the falling blocks</h3></center>
	<center id='gamearea'></center>

</body>
</html>
